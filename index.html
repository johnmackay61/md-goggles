<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MD-Goggles</title>
</head>
<body>
  <div id="content">Loading...</div>
  
  <!-- Include marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Include DOMPurify for sanitizing HTML to prevent XSS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
  
  <script>
    // Function to load and render the Markdown file based on the hashbang URL
    function loadMarkdownPage() {
      var hash = window.location.hash;
      if (hash.startsWith("#!/")) {
        // Remove "#!/" to get the page path
        var page = hash.slice(3);
        var url;
        
        // If no page is specified, default to "index.md"
        if (page === "") {
          url = "index.md";
        } else {
          // If the page ends with a slash, assume it's a directory and append "index.md"
          if (page.endsWith("/")) {
            url = page + "index.md";
          } else {
            // If there's no dot, assume a file name without extension and add ".md"
            if (!page.includes(".")) {
              url = page + ".md";
            } else {
              url = page;
            }
          }
        }
        
        // Function to fetch and render Markdown content
        function fetchMarkdown(urlToFetch) {
          fetch(urlToFetch)
            .then(response => {
              if (!response.ok) {
                // If the Markdown file is not found and it's not already the 404 page, load 404.md
                if (urlToFetch !== "404.md") {
                  return fetchMarkdown("404.md");
                } else {
                  throw new Error("404 page not found");
                }
              }
              return response.text();
            })
            .then(markdown => {
              // Parse Markdown to HTML using marked.js
              var rawHtml = marked.parse(markdown);
              // Sanitize the generated HTML with DOMPurify to prevent XSS attacks
              var cleanHtml = DOMPurify.sanitize(rawHtml);
              document.getElementById("content").innerHTML = cleanHtml;
            })
            .catch(error => {
              document.getElementById("content").innerHTML = "Error loading page: " + error;
            });
        }
        
        fetchMarkdown(url);
      }
    }

    // Listen for hash changes and page load to render the corresponding Markdown
    window.addEventListener("hashchange", loadMarkdownPage);
    window.addEventListener("load", loadMarkdownPage);
  </script>
  
  <script>
  // Function to convert a string to Title Case
  function toTitleCase(str) {
    return str.replace(/\b\w+/g, function(word) {
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    });
  }

  // Function to update the document title based on the hashbang URL
  function updateTitleFromHash() {
    var hash = window.location.hash;
    if (hash.startsWith("#!/")) {
      // Extract the path after "#!/"
      var page = hash.slice(3);
      // Remove any trailing slash (for directories)
      if (page.endsWith("/")) {
        page = page.slice(0, -1);
      }
      // Split the path by '/' and take the last segment as the file name
      var segments = page.split('/');
      var fileName = segments[segments.length - 1] || 'Home';
      // Replace dashes and underscores with spaces for readability
      fileName = fileName.replace(/[-_]/g, ' ');
      // Convert to Title Case and update the document title
      document.title = toTitleCase(fileName);
    } else {
      // Default title when no hashbang is present
      document.title = 'Home';
    }
  }

  // Update the title on page load and when the hash changes
  window.addEventListener("load", updateTitleFromHash);
  window.addEventListener("hashchange", updateTitleFromHash);
</script>

</body>
</html>
